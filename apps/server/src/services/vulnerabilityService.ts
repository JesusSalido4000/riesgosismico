import { clamp } from '../utils/clamp';

export type VulnerabilityInput = {
  añoConstruccion: number;
  material: 'concrete' | 'masonry' | 'steel' | 'wood' | 'mixed';
  niveles: number;
  irregularidad: 'none' | 'plan' | 'vertical' | 'both';
  mantenimiento: 'good' | 'regular' | 'poor';
  grietasPrevias: boolean;
};

export const evaluateVulnerability = (input: VulnerabilityInput) => {
  const breakdown: Array<{ factor: string; contribution: number; note: string }> = [];
  let score = 0.2;

  const ageContribution = input.añoConstruccion < 1985 ? 0.2 : input.añoConstruccion < 2000 ? 0.12 : 0.06;
  score += ageContribution;
  breakdown.push({ factor: 'Año de construcción', contribution: ageContribution, note: input.añoConstruccion < 1985 ? 'Normatividad sísmica más limitada' : 'Normatividad más reciente' });

  const materialMap = { concrete: 0.08, masonry: 0.2, steel: 0.05, wood: 0.09, mixed: 0.14 };
  const materialContribution = materialMap[input.material];
  score += materialContribution;
  breakdown.push({ factor: 'Material', contribution: materialContribution, note: input.material === 'masonry' ? 'Mampostería puede ser más frágil sin refuerzo' : 'Comportamiento esperado del material' });

  const levelContribution = clamp((input.niveles - 1) * 0.025, 0, 0.22);
  score += levelContribution;
  breakdown.push({ factor: 'Niveles', contribution: levelContribution, note: 'Mayor altura incrementa demanda sísmica' });

  const irregularityMap = { none: 0, plan: 0.09, vertical: 0.12, both: 0.18 };
  const irregularityContribution = irregularityMap[input.irregularidad];
  score += irregularityContribution;
  breakdown.push({ factor: 'Irregularidad', contribution: irregularityContribution, note: 'Irregularidades concentran daños' });

  const maintenanceMap = { good: 0.03, regular: 0.09, poor: 0.18 };
  const maintenanceContribution = maintenanceMap[input.mantenimiento];
  score += maintenanceContribution;
  breakdown.push({ factor: 'Mantenimiento', contribution: maintenanceContribution, note: input.mantenimiento === 'poor' ? 'Deterioro visible incrementa vulnerabilidad' : 'Condición general observada' });

  const crackContribution = input.grietasPrevias ? 0.12 : 0;
  score += crackContribution;
  breakdown.push({ factor: 'Grietas previas', contribution: crackContribution, note: input.grietasPrevias ? 'Daño previo reportado' : 'Sin daño previo reportado' });

  const V = Number(clamp(score, 0, 1).toFixed(3));

  return { V, breakdown };
};
