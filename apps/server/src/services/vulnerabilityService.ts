import { clamp } from '../utils/clamp.js';

export interface VulnerabilityInput {
  añoConstruccion: number;
  material: 'concrete' | 'masonry' | 'steel' | 'wood' | 'mixed';
  niveles: number;
  irregularidad: 'none' | 'plan' | 'vertical' | 'both';
  mantenimiento: 'good' | 'regular' | 'poor';
  grietasPrevias: boolean;
}

export const computeVulnerability = (input: VulnerabilityInput): { V: number; breakdown: Array<{ factor: string; contribution: number; note: string }> } => {
  const breakdown: Array<{ factor: string; contribution: number; note: string }> = [];

  const yearC = input.añoConstruccion < 1985 ? 0.25 : input.añoConstruccion < 2005 ? 0.12 : 0.05;
  breakdown.push({ factor: 'Año de construcción', contribution: yearC, note: input.añoConstruccion < 1985 ? 'Previo a criterios modernos' : 'Normativa más reciente' });

  const matMap: Record<VulnerabilityInput['material'], number> = { concrete: 0.1, masonry: 0.24, steel: 0.08, wood: 0.12, mixed: 0.18 };
  breakdown.push({ factor: 'Material', contribution: matMap[input.material], note: `Material ${input.material}` });

  const levelsC = clamp((input.niveles - 1) * 0.03, 0, 0.27);
  breakdown.push({ factor: 'Niveles', contribution: levelsC, note: `${input.niveles} niveles` });

  const irrMap: Record<VulnerabilityInput['irregularidad'], number> = { none: 0.03, plan: 0.12, vertical: 0.14, both: 0.2 };
  breakdown.push({ factor: 'Irregularidad', contribution: irrMap[input.irregularidad], note: input.irregularidad });

  const maintMap: Record<VulnerabilityInput['mantenimiento'], number> = { good: 0.04, regular: 0.11, poor: 0.2 };
  breakdown.push({ factor: 'Mantenimiento', contribution: maintMap[input.mantenimiento], note: input.mantenimiento });

  const crackC = input.grietasPrevias ? 0.15 : 0.02;
  breakdown.push({ factor: 'Grietas previas', contribution: crackC, note: input.grietasPrevias ? 'Con grietas observadas' : 'Sin grietas reportadas' });

  const V = clamp(breakdown.reduce((acc, x) => acc + x.contribution, 0), 0, 1);
  return { V, breakdown };
};
